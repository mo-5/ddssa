""" tests contains any unit tests for backend files
"""
import json
import os
import unittest

import requests
from jsonschema import validate

from capstone_project.backend.api.vulnerability_query import VulnerabilityQuery
from capstone_project.tests.test_utils import TestUtils


class TestVulnerabilityQuery(unittest.TestCase):
    """TestVulnerabilityQuery is responsible for ensuring the correct
    functionality of query sent and received from the CPE database.
    """

    def setUp(self):
        self._test_path = TestUtils().get_test_path()
        self._api_query = VulnerabilityQuery.instance()

    def test_query_creation(self):
        """"""
        pass

    def test_response_data(self):
        """Validate a query response retrieved from the NIST CPE
        database against the provided schema."""
        with open(
            os.path.join(
                self._test_path,
                "schemas",
                "query_schema_cpe.json",
            )
        ) as file:
            schema_file_request = json.load(file)

        with open(
            os.path.join(
                self._test_path,
                "schemas",
                "response_schema_cpe.json",
            )
        ) as file:
            schema_file_return = json.load(file)

        default_params = {
            "addOns": "cves",
            "keyword": "Django 1.12.1",
            "resultsPerPage": 2000,
            "startIndex": 0,
            "includeDeprecated": "true",
        }

        try:
            validate(
                default_params,
                schema=schema_file_request,
            )
        except ValueError:
            self.fail(
                "Returned json data failed to validate against the "
                "query_schema_cpe.json schema."
            )

        try:
            validate(
                requests.get(self._api_query._url, params=default_params).json(),
                schema=schema_file_return,
            )
        except ValueError:
            self.fail(
                "Returned json data failed to validate against the "
                "response_schema_cpe.json schema."
            )
